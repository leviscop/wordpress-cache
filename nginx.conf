user  nginx;
worker_processes  auto;
error_log  /dev/null  crit;
pid        /var/run/nginx.pid;
events {
    worker_connections  1024;
}
http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    access_log  /dev/null;
    sendfile        on;
    keepalive_timeout  65;
    server_tokens off;
    fastcgi_cache_path /tmp/wordpress_cache keys_zone=wordpress_cache:100m levels=1:2 inactive=60m max_size=500m;
    fastcgi_cache_key "$scheme$request_method$host$request_uri";
    server {
        listen [::]:80 default_server;
        listen 80 default_server;
        server_name _;
        if ( $request_method !~ ^(GET|POST|HEAD)$ ) {
        return 501;
        }
        limit_conn conn_limit_per_ip 20;
        limit_req zone=req_limit_per_ip burst=60 nodelay;
        if ($http_user_agent ~* ApacheBench) {
                return 403;
        }
        root /var/www/html;
        index index.php;

        set $skip_cache 0;

        if ($request_method = POST) {
                set $skip_cache 1;
        }   

        if ($query_string != "") {
                set $skip_cache 1;
        }

        if ($request_uri ~* "/wp-admin/|/xmlrpc.php|wp-.*.php|/feed/|index.php|sitemap(_index)?.xml") {
                set $skip_cache 1;
        }   

        if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_no_cache|wordpress_logged_in") {
                set $skip_cache 1;
        }

        location / {
                try_files $uri $uri/ /index.php?$args;
        }

        location ~ .(gif|png|jpe?g)$ {
                valid_referers none blocked leuten.de *.leuten.de;
                if ($invalid_referer) {
                        return   403;
                }
        }

        location ~* .(ogg|ogv|svg|svgz|eot|otf|woff|mp4|ttf|css|rss|atom|js|jpg|jpeg|gif|png|ico|zip|tgz|gz|rar|bz2|doc|xls|exe|ppt|tar|mid|midi|wav|bmp|rtf)$ {
                expires max;
                log_not_found off;
                access_log off;
        }

        location ~* wp-config.php {
                deny all;
        }

        location ~* /(\.|wp-config\.php|wp-config\.txt|changelog\.txt|readme\.txt|readme\.html|license\.txt) {
                deny all;
        }

        location ~* ^/wp-content/uploads/.*.(html|htm|shtml|php|js|swf)$ {
                deny all;
        }

        location ~* \.(engine|inc|info|install|make|module|profile|test|po|sh|.*sql|theme|tpl(\.php)?|xtmpl)\$|^(\..*|Entries.*|Repository|Root|Tag|Template)\$|\.php_ {
                return 444;
        }

        location ~* .(pl|cgi|py|sh|lua)$ {
                return 444;
        }

        location ~ \.php$ {
                try_files $uri /index.php;
                fastcgi_cache_bypass $skip_cache;
                fastcgi_no_cache $skip_cache;
                fastcgi_cache wordpress_cache;
                fastcgi_cache_valid 2m;
                fastcgi_split_path_info ^(.+\.php)(/.+)$;
                fastcgi_pass wordpress:9000;
                fastcgi_param PATH_TRANSLATED $document_root$fastcgi_script_name;
                fastcgi_index index.php;
                include fastcgi_params;
        }
    }
}
